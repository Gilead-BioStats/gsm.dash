---
title: "Live Dashboard"
vignette: >
  %\VignetteIndexEntry{Live Dashboard}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
knitr:
  opts_chunk:
    collapse: true
    comment: '#>'
filters:
  - shinylive
---

::: {.shinylive data-shinylive-id="dashboard-app"}
```{shinylive-r}
#| standalone: true
library(shiny)

ui <- fluidPage(
  tags$script(HTML(
    "document.addEventListener('DOMContentLoaded', function () {
      window.addEventListener('message', function (event) {
        if (event.data.type === 'set-pat') {
          Shiny.setInputValue('pat', event.data.pat);
          event.source.postMessage({ type: 'ack-pat' }, event.origin);
        }
      });

      // Set a property on the iframe's window object to indicate Shiny is ready
      Shiny.initializedPromise.then(() => {
        console.log('Shiny is fully initialized!');
        window.shinyReady = true;
      });
    });"
  )),
  verbatimTextOutput("pat_display")
)

server <- function(input, output, session) {
  output$pat_display <- renderText({
    paste("Your PAT is:", input$pat)
  })
}

shinyApp(ui, server)
```
:::

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const observer = new MutationObserver((mutations, observerInstance) => {
      const iframe = document.querySelector('div[data-shinylive-id="dashboard-app"] iframe');
      if (iframe) {
        console.log('Iframe is ready.');
        observerInstance.disconnect(); // Stop observing once iframe is found

        const pat = "testValue"; // Set a test value for the PAT

        // Wait for the iframe to indicate Shiny is ready
        const waitForShinyReady = new Promise((resolve) => {
          const observerForShinyReady = new MutationObserver(() => {
            if (iframe.contentWindow && iframe.contentWindow.shinyReady) {
              resolve();
              observerForShinyReady.disconnect(); // Stop observing once shinyReady is true
            }
          });
          observerForShinyReady.observe(iframe.contentWindow.document, { childList: true, subtree: true });
        });

        waitForShinyReady.then(() => {
          console.log('Shiny app is ready. Sending PAT...');
          iframe.contentWindow.postMessage({ type: 'set-pat', pat }, '*');

          // Set up the listener for acknowledgment
          window.addEventListener('message', function handleAck(event) {
            if (event.data.type === 'ack-pat') {
              console.log('Shiny app acknowledged the PAT.');
              window.removeEventListener('message', handleAck);
            }
          });
        });
      }
    });

    // Observe the DOM for changes in the div containing the iframe
    const target = document.querySelector('div[data-shinylive-id="dashboard-app"]');
    if (target) {
      observer.observe(target, { childList: true, subtree: true });
    } else {
      console.error('Target div for iframe not found.');
    }
  });
</script>
